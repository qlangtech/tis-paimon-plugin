
åœ¨ Apache Paimon ä¸­ï¼Œ`bucket` å‚æ•°å®šä¹‰äº†è¡¨æ•°æ®çš„å­˜å‚¨åˆ†æ¡¶ç­–ç•¥ï¼Œè¿™æ˜¯ Paimon çš„æ ¸å¿ƒè®¾è®¡ä¹‹ä¸€ã€‚ä¸åŒå€¼å¯¹åº”å®Œå…¨ä¸åŒçš„å­˜å‚¨å’Œå†™å…¥æ¨¡å¼ï¼š

### ğŸª£ ä¸‰ç§ Bucket æ¨¡å¼è¯¦è§£

| **æ¨¡å¼**         | **å€¼** | **ç‰¹ç‚¹**                                                                 | **é€‚ç”¨åœºæ™¯**                     |
|------------------|--------|--------------------------------------------------------------------------|----------------------------------|
| **å›ºå®šæ¡¶æ¨¡å¼**    | >0     | å›ºå®šæ•°é‡çš„æ¡¶ï¼Œæ¡¶æ•°ä¸å¯å˜                                                 | æ•°æ®åˆ†å¸ƒå‡åŒ€çš„é™æ€è¡¨             |
| **åŠ¨æ€æ¡¶æ¨¡å¼**    | -1     | æ¡¶æ•°é‡è‡ªåŠ¨æ‰©å±•/æ”¶ç¼©ï¼Œæ ¹æ®æ•°æ®é‡è°ƒæ•´                                      | æ•°æ®é‡å˜åŒ–å¤§çš„é€šç”¨åœºæ™¯ï¼ˆæ¨èï¼‰   |
| **å»¶è¿Ÿæ¡¶æ¨¡å¼**    | -2     | å†™å…¥æ—¶ä¸ç«‹å³åˆ†æ¡¶ï¼Œå…ˆå­˜ä¸´æ—¶æ–‡ä»¶ï¼ŒCompaction æ—¶æ‰åˆ†æ¡¶                      | è¶…é«˜ååå†™å…¥çš„ Append-Only è¡¨    |

---

### ğŸ”§ æ·±åº¦è§£æä¸‰ç§æ¨¡å¼

#### 1. å›ºå®šæ¡¶æ¨¡å¼ (`bucket = N`, N > 0)
```sql
CREATE TABLE fixed_bucket_table (...) WITH (
  'bucket' = '5'  -- å›ºå®š5ä¸ªæ¡¶
);
```
- **å·¥ä½œåŸç†**ï¼š
    - æ•°æ®æ ¹æ®ä¸»é”®å“ˆå¸Œåˆ†é…åˆ°å›ºå®š N ä¸ªæ¡¶
    - æ¯ä¸ªæ¡¶å¯¹åº”ä¸€ä¸ªç›®å½•ï¼ˆå¦‚ `bucket-0`, `bucket-1`ï¼‰
    - æ¡¶æ•°é‡**æ°¸ä¸æ”¹å˜**
- **å±€é™æ€§**ï¼š
    - æ•°æ®å€¾æ–œæ—¶æŸäº›æ¡¶ä¼šè¿‡å¤§
    - æ‰©å®¹éœ€é‡å†™å…¨è¡¨æ•°æ®
    - å°è¡¨å¯èƒ½äº§ç”Ÿç©ºæ¡¶

#### 2. åŠ¨æ€æ¡¶æ¨¡å¼ (`bucket = -1`) â˜… æœ€å¸¸ç”¨
```sql
CREATE TABLE dynamic_bucket_table (...) WITH (
  'bucket' = '-1'  -- åŠ¨æ€æ¡¶æ¨¡å¼
);
```
- **æ ¸å¿ƒæœºåˆ¶**ï¼š
    1. **åˆå§‹çŠ¶æ€**ï¼šåªæœ‰ 1 ä¸ªæ¡¶
    2. **æ¡¶åˆ†è£‚**ï¼šå½“æ¡¶æ•°æ®é‡ > `bucket-target-file-size`ï¼ˆé»˜è®¤ 128MBï¼‰æ—¶ï¼Œè‡ªåŠ¨åˆ†è£‚ä¸º 2 ä¸ªæ–°æ¡¶
    3. **æ¡¶åˆå¹¶**ï¼šå½“æ¡¶æ•°æ®é‡ < åˆ†è£‚é˜ˆå€¼/2 æ—¶ï¼Œå¯èƒ½åˆå¹¶ç›¸é‚»æ¡¶
- **ä¼˜åŠ¿**ï¼š
    - è‡ªåŠ¨é€‚åº”æ•°æ®å¢é•¿
    - é¿å…å°æ–‡ä»¶é—®é¢˜
    - ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼ˆå‡å°‘æ‰«ææ•°æ®é‡ï¼‰
- **é…ç½®å‚æ•°**ï¼š
  ```sql
  ALTER TABLE my_table SET (
    'bucket-target-file-size' = '256mb',  -- æ¡¶åˆ†è£‚é˜ˆå€¼
    'min-bucket-num' = '1',               -- æœ€å°æ¡¶æ•°
    'max-bucket-num' = '100'              -- æœ€å¤§æ¡¶æ•°
  );
  ```

#### 3. å»¶è¿Ÿæ¡¶æ¨¡å¼ (`bucket = -2`)
```sql
CREATE TABLE postpone_bucket_table (...) WITH (
  'bucket' = '-2',        -- å»¶è¿Ÿæ¡¶æ¨¡å¼
  'write-mode' = 'append-only'  -- å¿…é¡»ä¸ºappend-only
);
```
- **ç‰¹æ®Šå·¥ä½œæµ**ï¼š
  ```mermaid
  graph LR
    A[æ•°æ®å†™å…¥] --> B{æ˜¯å¦Compactionè§¦å‘?}
    B -->|å¦| C[å†™å…¥ä¸´æ—¶æ–‡ä»¶]
    B -->|æ˜¯| D[è¯»å–æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶]
    D --> E[æŒ‰ä¸»é”®åˆ†æ¡¶]
    E --> F[å†™å…¥æ­£å¼æ¡¶ç›®å½•]
  ```
- **è®¾è®¡ç›®çš„**ï¼š
    - **æé«˜å†™å…¥åå**ï¼šé¿å…å†™å…¥æ—¶ç«‹å³åˆ†æ¡¶çš„å¼€é”€
    - **å‡å°‘å°æ–‡ä»¶**ï¼šä¸´æ—¶æ–‡ä»¶æ›´å¤§ï¼Œåˆå¹¶æ—¶ç”Ÿæˆä¼˜åŒ–åçš„æ¡¶æ–‡ä»¶
- **ä¸¥æ ¼é™åˆ¶**ï¼š
    - ä»…æ”¯æŒ `append-only` è¡¨ï¼ˆä¸å¯æ›´æ–°/åˆ é™¤ï¼‰
    - æŸ¥è¯¢æ€§èƒ½è¾ƒå·®ï¼ˆéœ€æ‰«ææ‰€æœ‰ä¸´æ—¶æ–‡ä»¶ï¼‰

---

### âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹

1. **æ¨¡å¼åˆ‡æ¢é™åˆ¶**ï¼š
   ```sql
   -- ç¦æ­¢ä»å›ºå®šæ¡¶åˆ‡æ¢ä¸ºåŠ¨æ€æ¡¶
   ALTER TABLE t SET ('bucket' = '-1'); -- æŠ¥é”™ï¼
   
   -- å”¯ä¸€å…è®¸çš„åˆ‡æ¢æ–¹å‘ï¼š
   ALTER TABLE t SET ('bucket' = '-2'); -- å›ºå®šæ¡¶ â†’ å»¶è¿Ÿæ¡¶ï¼ˆéœ€æ»¡è¶³append-onlyï¼‰
   ```

2. **åŠ¨æ€æ¡¶çš„æ‰©å®¹è¿‡ç¨‹**ï¼š
   ```mermaid
   graph TB
     A[æ¡¶0: 128MB] -->|è¾¾åˆ°é˜ˆå€¼| B[åˆ†è£‚ä¸ºæ¡¶0å’Œæ¡¶1]
     B --> C[æ¡¶0: 64MB] 
     B --> D[æ¡¶1: 64MB]
     D -->|ç»§ç»­å†™å…¥| E[æ¡¶1: 180MB]
     E -->|å†æ¬¡è¾¾åˆ°é˜ˆå€¼| F[åˆ†è£‚ä¸ºæ¡¶1å’Œæ¡¶2]
   ```

3. **å»¶è¿Ÿæ¡¶çš„ Compaction è§¦å‘**ï¼š
   ```sql
   -- æ‰‹åŠ¨è§¦å‘å»¶è¿Ÿæ¡¶çš„åˆ†æ¡¶æ“ä½œ
   CALL sys.compact('db.postpone_table');
   
   -- è‡ªåŠ¨è§¦å‘é…ç½®
   ALTER TABLE postpone_table SET (
     'compaction.trigger' = 'process-time',  -- æŒ‰å¤„ç†æ—¶é—´è§¦å‘
     'compaction.interval' = '5 min'         -- æ¯5åˆ†é’Ÿå°è¯•ä¸€æ¬¡
   );
   ```

---

### ğŸš€ ç”Ÿäº§ç¯å¢ƒå»ºè®®

#### åœºæ™¯ 1ï¼šCDC æ•°æ®åŒæ­¥ï¼ˆå¦‚æ‚¨çš„ 2 äº¿æ•°æ®è¡¨ï¼‰
```sql
CREATE TABLE cdc_table (
  id BIGINT PRIMARY KEY,
  ...
) WITH (
  'bucket' = '-1',  -- â˜… åŠ¨æ€æ¡¶æœ€ä¼˜
  'bucket-target-file-size' = '256mb',
  'changelog-producer' = 'input'  -- æ”¯æŒæ›´æ–°
);
```

#### åœºæ™¯ 2ï¼šæ—¥å¿—ç±» Append-Only æ•°æ®
```sql
CREATE TABLE log_table (
  log_time TIMESTAMP(3),
  ...
) WITH (
  'bucket' = '-2',  -- å»¶è¿Ÿæ¡¶æ¨¡å¼
  'write-mode' = 'append-only',
  'compaction.max.file-num' = '100'  -- åˆå¹¶å¤§æ–‡ä»¶
);
```

#### åœºæ™¯ 3ï¼šå°å‹é™æ€ç»´åº¦è¡¨
```sql
CREATE TABLE dim_table (
  sku_id STRING PRIMARY KEY,
  ...
) WITH (
  'bucket' = '3',  -- å›ºå®šå°‘é‡æ¡¶
  'snapshot.time-retained' = '1 h'  -- çŸ­æ—¶ä¿ç•™
);
```

### ğŸ” é—®é¢˜æ’æŸ¥æŠ€å·§
è‹¥é‡åˆ°æ¡¶ç›¸å…³é—®é¢˜ï¼š
```sql
-- æŸ¥çœ‹æ¡¶åˆ†å¸ƒçŠ¶æ€
SELECT * FROM sys.buckets WHERE table_name = 'my_table';

-- æ£€æŸ¥æ¡¶å¤§å°åˆ†å¸ƒ
SELECT 
  bucket, 
  COUNT(*) AS file_count,
  SUM(file_size) AS total_size
FROM sys.snapshots 
WHERE table_name = 'my_table'
GROUP BY bucket;
```

åŠ¨æ€æ¡¶æ¨¡å¼ (`bucket=-1`) åœ¨å¤§å¤šæ•°ç”Ÿäº§åœºæ™¯ä¸­æ˜¯æœ€ä½³é€‰æ‹©ï¼Œå®ƒèƒ½è‡ªåŠ¨å¹³è¡¡æ•°æ®åˆ†å¸ƒï¼Œç‰¹åˆ«é€‚åˆæ‚¨çš„ 2 äº¿çº§æ•°æ®åŒæ­¥åœºæ™¯ã€‚


åœ¨ Apache Paimon ä¸­ï¼Œ`bucket-key` æ˜¯ä¸€ä¸ª**å…³é”®çš„åˆ†æ¡¶å­—æ®µé…ç½®**ï¼Œå®ƒå†³å®šäº†æ•°æ®åœ¨æ¡¶å†…çš„åˆ†å¸ƒæ–¹å¼ã€‚è¿™ä¸ªå‚æ•°ä¸ `bucket` æ¨¡å¼å¯†åˆ‡ç›¸å…³ï¼Œä½†åœ¨ä¸åŒæ¡¶æ¨¡å¼ä¸‹å…¶ä½œç”¨å’Œæœ‰æ•ˆæ€§æœ‰æ˜¾è‘—å·®å¼‚ã€‚ä¸‹é¢æˆ‘å°†è¯¦ç»†è§£é‡Šï¼š

---

### ğŸ—ï¸ `bucket-key` çš„æ ¸å¿ƒä½œç”¨
**å®šä¹‰æ•°æ®åœ¨æ¡¶å†…çš„åˆ†å¸ƒæ–¹å¼**ï¼š
- å½“æ•°æ®è¢«åˆ†é…åˆ°æŸä¸ªæ¡¶åï¼Œ`bucket-key` å†³å®šè¿™äº›æ•°æ®åœ¨æ¡¶å†…æ–‡ä»¶ä¸­çš„**ç‰©ç†æ’åºå’Œåˆ†å¸ƒ**
- ç±»ä¼¼äºä¼ ç»Ÿæ•°æ®åº“ä¸­çš„**èšç°‡ç´¢å¼•**ï¼ˆClustered Indexï¼‰
- ä¸»è¦å½±å“ï¼š
  1. **æŸ¥è¯¢æ€§èƒ½**ï¼šç›¸åŒ `bucket-key` çš„æ•°æ®ç‰©ç†ç›¸é‚»ï¼ŒèŒƒå›´æŸ¥è¯¢æ›´å¿«
  2. **Compactionæ•ˆç‡**ï¼šç›¸åŒé”®å€¼çš„æ•°æ®æ›´å®¹æ˜“åˆå¹¶
  3. **æ•°æ®å±€éƒ¨æ€§**ï¼šä¼˜åŒ– JOIN å’Œèšåˆæ“ä½œ

---

### ğŸ”„ `bucket-key` åœ¨ä¸åŒæ¡¶æ¨¡å¼ä¸‹çš„æœ‰æ•ˆæ€§

#### 1. **å›ºå®šæ¡¶æ¨¡å¼ (`bucket > 0`)**
- âœ… **å®Œå…¨æœ‰æ•ˆä¸”æ¨èä½¿ç”¨**
- å·¥ä½œæ–¹å¼ï¼š
  ```mermaid
  graph LR
    A[æ–°æ•°æ®] --> B{å“ˆå¸Œåˆ†æ¡¶}
    B -->|bucket=5| C[æ¡¶0-4]
    C --> D[æŒ‰bucket-keyæ’åºå­˜å‚¨]
  ```
- ç¤ºä¾‹ï¼š
  ```sql
  CREATE TABLE users (
      user_id BIGINT,
      region STRING,
      ...
  ) WITH (
      'bucket' = '8',  -- å›ºå®š8ä¸ªæ¡¶
      'bucket-key' = 'region'  -- æŒ‰regionåœ¨æ¡¶å†…æ’åº
  )
  ```
- æ•ˆæœï¼š
  - ç›¸åŒ `region` çš„ç”¨æˆ·åœ¨åŒä¸€ä¸ªæ¡¶å†…ç‰©ç†ç›¸é‚»
  - `WHERE region='Asia'` åªéœ€æ‰«æå°‘é‡æ–‡ä»¶

#### 2. **åŠ¨æ€æ¡¶æ¨¡å¼ (`bucket = -1`)**
- âš ï¸ **æœ‰æ¡ä»¶æœ‰æ•ˆ**
- é™åˆ¶ï¼š
  - ä»…å½“ **`bucket-key` = ä¸»é”®ï¼ˆæˆ–ä¸»é”®å­é›†ï¼‰** æ—¶æ‰æœ‰æ•ˆ
  - å¦‚æœè®¾ç½®éä¸»é”®å­—æ®µï¼ŒPaimon ä¼š**é™é»˜å¿½ç•¥**è¯¥é…ç½®
- åŸå› ï¼š
  - åŠ¨æ€æ¡¶éœ€è¦æ ¹æ®ä¸»é”®åˆ†è£‚/åˆå¹¶æ¡¶
  - æ¡¶å†…æ’åºå¿…é¡»ä¸æ¡¶åˆ†è£‚é€»è¾‘ä¸€è‡´
- æ­£ç¡®ç¤ºä¾‹ï¼š
  ```sql
  CREATE TABLE orders (
      order_id STRING PRIMARY KEY,
      customer_id BIGINT,
      ...
  ) WITH (
      'bucket' = '-1',
      'bucket-key' = 'order_id'  -- å¿…é¡»ç­‰äºä¸»é”®
  )
  ```

#### 3. **å»¶è¿Ÿæ¡¶æ¨¡å¼ (`bucket = -2`)**
- âŒ **å®Œå…¨æ— æ•ˆ**
- åŸå› ï¼š
  - å»¶è¿Ÿæ¡¶æ¨¡å¼å†™å…¥æ—¶**ä¸ç«‹å³åˆ†æ¡¶**
  - æ•°æ®ä»¥ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ï¼ŒCompaction æ—¶æ‰åˆ†æ¡¶
  - `bucket-key` åœ¨å†™å…¥é˜¶æ®µæ— æ³•ç”Ÿæ•ˆ
- æ›¿ä»£æ–¹æ¡ˆï¼š
  ```sql
  CREATE TABLE logs (
      log_time TIMESTAMP(3),
      device_id STRING,
      ...
  ) WITH (
      'bucket' = '-2',
      'write-mode' = 'append-only',
      -- ä½¿ç”¨partitionå’Œsorté”®ä»£æ›¿
      'partition' = 'dt', 
      'sort-key' = 'log_time,device_id'
  )
  ```

---

### ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“

| **æ¡¶æ¨¡å¼**      | `bucket-key` æ˜¯å¦æœ‰æ•ˆ | æ¨èé…ç½®ç­–ç•¥                          |
|----------------|---------------------|---------------------------------------|
| **å›ºå®šæ¡¶ (>0)**  | âœ… æœ‰æ•ˆ              | è®¾ç½®ä¸ºé«˜é¢‘è¿‡æ»¤/JOINçš„å­—æ®µ              |
| **åŠ¨æ€æ¡¶ (-1)**  | âš ï¸ ä»…å½“ç­‰äºä¸»é”®æ—¶æœ‰æ•ˆ | å¿…é¡»è®¾ç½®ä¸ºè¡¨çš„ä¸»é”®å­—æ®µ                  |
| **å»¶è¿Ÿæ¡¶ (-2)**  | âŒ æ— æ•ˆ              | æ”¹ç”¨ `partition` + `sort-key` æ›¿ä»£æ–¹æ¡ˆ |

---

### âš™ï¸ é…ç½®å»ºè®®

#### åœºæ™¯ 1ï¼šä¸»é”®è¡¨ï¼ˆå¦‚ç”¨æˆ·è¡¨ï¼‰
```sql
CREATE TABLE users (
    user_id STRING PRIMARY KEY,
    country STRING,
    ...
) WITH (
    'bucket' = '-1',  -- åŠ¨æ€æ¡¶
    'bucket-key' = 'user_id',  -- å¿…é¡»=ä¸»é”®
    'bucket-target-file-size' = '256mb'
)
```

#### åœºæ™¯ 2ï¼šæ— ä¸»é”®å¤§è¡¨ï¼ˆå¦‚æ—¥å¿—è¡¨ï¼‰
```sql
CREATE TABLE server_logs (
    log_time TIMESTAMP(3),
    ip STRING,
    ...
) WITH (
    'bucket' = '32',  -- å›ºå®šæ¡¶
    'bucket-key' = 'log_time',  -- æŒ‰æ—¶é—´æ’åº
    'partition' = 'dt'  -- æŒ‰å¤©åˆ†åŒº
)
```

#### åœºæ™¯ 3ï¼šè¶…é«˜ååå†™å…¥
```sql
CREATE TABLE sensor_data (
    device STRING,
    ts TIMESTAMP(3),
    ...
) WITH (
    'bucket' = '-2',  -- å»¶è¿Ÿæ¡¶
    'write-mode' = 'append-only',
    -- bucket-keyæ— æ•ˆï¼Œæ”¹ç”¨sort-key
    'sort-key' = 'device,ts',
    'compaction.trigger' = 'process-time'
)
```

---

### âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹
1. **åŠ¨æ€æ¡¶çš„ç‰¹æ®Šçº¦æŸ**ï¼š
   ```java
   // å¦‚æœå°è¯•è®¾ç½®éä¸»é”®bucket-keyä¼šæŠ¥é”™
   if (bucket == -1 && !bucketKeys.equals(primaryKeys)) {
       throw new IllegalArgumentException("Dynamic bucket mode requires bucket-key=primary key");
   }
   ```

2. **æ€§èƒ½å½±å“**ï¼š
  - å¥½çš„ `bucket-key` å¯æå‡ 3-10 å€æŸ¥è¯¢æ€§èƒ½
  - é”™è¯¯é…ç½®å¯èƒ½å¯¼è‡´æ•°æ®å€¾æ–œï¼ˆå›ºå®šæ¡¶æ¨¡å¼ï¼‰

3. **å­˜å‚¨ç»“æ„å¯è§†åŒ–**ï¼š
   ```
   /user/hive/warehouse/my_table
     â”œâ”€â”€ bucket-0
     â”‚   â”œâ”€â”€ part-0.parquet  # å†…éƒ¨æŒ‰bucket-keyæ’åº
     â”‚   â””â”€â”€ part-1.parquet
     â”œâ”€â”€ bucket-1
     â”‚   â””â”€â”€ ... 
     â””â”€â”€ ...
   ```

é€šè¿‡åˆç†é…ç½® `bucket-key`ï¼Œæ‚¨å¯ä»¥æ˜¾è‘—ä¼˜åŒ– Paimon è¡¨çš„æŸ¥è¯¢æ€§èƒ½å’Œå†™å…¥æ•ˆç‡ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†äº¿çº§æ•°æ®æ—¶æ•ˆæœæ›´ä¸ºæ˜æ˜¾ã€‚